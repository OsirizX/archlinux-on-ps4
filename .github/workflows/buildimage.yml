name: Create Arch Linux image

on:
  workflow_dispatch:

env:
  ARCH_VERSION: 2024.06.01

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Set version vars
        shell: bash
        run: |
          echo "ARCH_DATE=$(echo ${{ env.ARCH_VERSION }} | sed -r 's/\./\//g')" >> $GITHUB_ENV
          echo "OUTPUT_VERSION=$(echo ${{ env.ARCH_VERSION }} | sed -r 's/\.//g')" >> $GITHUB_ENV

      - name: Download Arch Linux
        run: wget -q https://archive.archlinux.org/iso/${{ env.ARCH_VERSION }}/archlinux-bootstrap-x86_64.tar.zst

      - name: Install dependencies
        run: |
          sudo mkdir archlinux
          sudo tar --numeric-owner --strip-components=1 -xpf archlinux-bootstrap-x86_64.tar.zst -C archlinux

          sudo cp /etc/resolv.conf archlinux/etc

          sudo mount -t proc /proc archlinux/proc/
          sudo mount -t sysfs /sys archlinux/sys/
          sudo mount --rbind /dev archlinux/dev/
          sudo mount --rbind /run archlinux/run/

          sudo chroot archlinux/ << "EOT"
          echo "LABEL=psxitarch / ext4 rw,relatime,data=ordered 0 1" >> /etc/fstab

          sed -i 's/CheckSpace/#CheckSpace/g' /etc/pacman.conf
          sed -i 's/#en_US.UTF-8 UTF-8/en_US.UTF-8 UTF-8/g' /etc/locale.gen
          sed -i 's/#en_GB.UTF-8 UTF-8/en_GB.UTF-8 UTF-8/g' /etc/locale.gen
          locale-gen

          echo "LANG=en_US.UTF-8" >> /etc/locale.conf
          echo "KEYMAP=us" >> /etc/vconsole.conf
          echo "playstation" >> /etc/hostname
          ln -sf /usr/share/zoneinfo/US/Pacific /etc/localetime

          cat >> /etc/pacman.conf << "EOF"
          [multilib]
          Include = /etc/pacman.d/mirrorlist

          [ps4]
          SigLevel = Never
          Server = https://psxita.it/repo-testing
          EOF

          [sevencoil]
          SigLevel = Never
          Server = https://archlinux.leondrolio.com/packages/$repo/os/$arch
          EOF

          cat << EOF > /etc/pacman.d/mirrorlist
          Server = https://archive.archlinux.org/repos/${{ env.ARCH_DATE }}/\$repo/os/\$arch
          Server = https://america.archive.pkgbuild.com/repos/${{ env.ARCH_DATE }}/\$repo/os/\$arch
          EOF

          pacman-key --init
          pacman-key --populate archlinux
          pacman --noconfirm -Syu
          pacman --noconfirm -S sudo base-devel git vim tmux wget curl alacritty \
                                mesa-ps4 lib32-libdrm-ps4 lib32-mesa-ps4 libdrm-ps4 xf86-video-amdgpu-ps4 \
                                llvm14 llvm14-libs meson libvdpau lib32-libvdpau libva lib32-libva libva-utils python-mako \
                                wayland xorg-xwayland xorg-xinit sway i3 \
                                pipewire pipewire-audio wireplumber pipewire-alsa pipewire-pulse alsa-utils \
                                x11vnc

          mkdir -p /lib/firmware/edid

          useradd -m pi -G wheel
          passwd pi
          raspberry
          raspberry

          echo '%wheel ALL=(ALL:ALL) NOPASSWD: ALL' >> /etc/sudoers
          echo 'Defaults lecture="never"' >> /etc/sudoers

          su pi
          cd ~/
          touch ~/.sudo_as_admin_successful

          git clone https://github.com/7coil/archlinux-packages.git archlinux-packages
          cd archlinux-packages
          cd lib32-libdrm-ps4
          makepkg -df
          cd ../libdrm-ps4
          makepkg -df
          cd ../xf86-video-amdgpu-ps4
          makepkg -df
          cd ../lib32-mesa-ps4
          makepkg -df
          cd ../mesa-ps4
          makepkg -df
          cd ..
          sudo pacman --noconfirm -U lib32-libdrm-ps4/*.tar.zst libdrm-ps4/*.tar.zst xf86-video-amdgpu-ps4/*.tar.zst lib32-mesa-ps4/*.tar.zst mesa-ps4/*.tar.zst
          cd ..

          git clone https://aur.archlinux.org/yay-bin.git
          cd yay-bin
          makepkg -si --noconfirm
          cd ..
          exit
          EOT

          sudo umount -l archlinux/proc/
          sudo umount -l archlinux/sys/
          sudo umount -l archlinux/dev/
          sudo umount -l archlinux/run/

          sudo tar -czpf archlinux-${{ env.OUTPUT_VERSION }}.tar.xz --one-file-system -C archlinux .

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: archlinux-${{ env.OUTPUT_VERSION }}
          path: archlinux-${{ env.OUTPUT_VERSION }}.tar.xz
